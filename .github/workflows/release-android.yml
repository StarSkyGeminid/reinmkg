name: Android Release

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
      ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.4"

      - name: Decode Android keystore
        run: |
          if [ -n "${ANDROID_KEYSTORE}" ]; then
            echo "$ANDROID_KEYSTORE" | base64 --decode > android/app/key.jks
          else
            echo "No keystore provided; skipping keystore decode."
          fi

      - name: Create android/key.properties
        run: |
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=key.jks" >> android/key.properties

      - name: Validate keystore and properties
        run: |
          echo "Validating keystore and key properties..."
          # Fail early if any secret is missing
          if [ -z "${ANDROID_KEYSTORE}" ] || [ -z "${ANDROID_STORE_PASSWORD}" ] || [ -z "${ANDROID_KEY_PASSWORD}" ] || [ -z "${ANDROID_KEY_ALIAS}" ]; then
            echo "ERROR: One or more Android keystore secrets are missing.\nCheck ANDROID_KEYSTORE, ANDROID_STORE_PASSWORD, ANDROID_KEY_PASSWORD, ANDROID_KEY_ALIAS." >&2
            echo "Listing files for debug:" >&2
            ls -l android || true
            echo "Contents of android/key.properties:" >&2
            sed -n '1,200p' android/key.properties || true
            exit 1
          fi

          # Ensure the keystore file exists and is non-empty
          if [ ! -s android/app/key.jks ]; then
            echo "ERROR: Keystore file android/app/key.jks is missing or empty." >&2
            ls -l android/app || true
            exit 1
          fi

          # Try to list the keystore contents to validate passwords/alias. This will fail with a clear message if password/alias incorrect.
          set -o pipefail
          keytool -list -v -keystore android/app/key.jks -storepass "${ANDROID_STORE_PASSWORD}" -keypass "${ANDROID_KEY_PASSWORD}" -alias "${ANDROID_KEY_ALIAS}" 2>&1 | sed -n '1,200p'
          status=$?
          if [ $status -ne 0 ]; then
            echo "ERROR: keytool failed to read the keystore with provided passwords/alias (exit $status)." >&2
            exit $status
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Build APKs (split per ABI, release)
        run: flutter build apk --release --split-per-abi

      - name: Build universal APK (release)
        run: flutter build apk --release

      - name: Build AAB (release)
        run: flutter build appbundle --release

      - name: Set tag and version
        id: vars
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare split-ABI APK and AAB artifacts with versioned names
        run: |
          VERSION=${{ steps.vars.outputs.VERSION }}
          TAG=${{ steps.vars.outputs.TAG }}
          mkdir -p release_artifacts
          # Copy universal APK if present
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-release.apk "release_artifacts/ReinMKG-${TAG}.apk"
          fi
          # Copy AAB if present
          if ls build/app/outputs/bundle/release/*.aab 1> /dev/null 2>&1; then
            for f in build/app/outputs/bundle/release/*.aab; do
              mv "$f" "release_artifacts/ReinMKG-${TAG}.aab"
            done
          fi
          # Copy split APKs produced by Flutter and normalize ABI names (skip universal)
          for f in build/app/outputs/flutter-apk/*-release.apk; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            if [ "$base" = "app-release.apk" ]; then
              continue
            fi
            abi=${base#app-}
            abi=${abi%-release.apk}
            case "$abi" in
              arm64-v8a) abi_label=arm64;;
              armeabi-v7a) abi_label=armeabi-v7a;;
              x86_64) abi_label=x86_64;;
              x86) abi_label=x86;;
              *) abi_label=$abi;;
            esac
            mv "$f" "release_artifacts/ReinMKG-${TAG}-${abi_label}.apk"
          done

      - name: Generate changelog from tag and commits
        run: |
          TAG=${{ steps.vars.outputs.TAG }}
          VERSION=${{ steps.vars.outputs.VERSION }}
          git fetch --prune --unshallow --tags || true
          # find previous tag (most recent tag that's not the current one)
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${TAG}$" | sed -n '1p' || true)

          # Try to extract tag message (works for annotated tags and falls back to commit message)
          TAG_MSG=$(git cat-file -p "${TAG}" 2>/dev/null | sed '1,/^$/d' || true)
          if [ -z "$TAG_MSG" ]; then
            TAG_MSG=$(git log -1 --pretty=%B "${TAG}" 2>/dev/null || true)
          fi
          if [ -z "$TAG_MSG" ]; then
            TAG_MSG="(no tag description)"
          fi

          # Write header + tag description
          echo "## Update description" >> release_artifacts/changelog-${VERSION}.md
          echo "" >> release_artifacts/changelog-${VERSION}.md
          printf "%s\n" "$TAG_MSG" >> release_artifacts/changelog-${VERSION}.md
          echo "" >> release_artifacts/changelog-${VERSION}.md
          echo "## Changes" >> release_artifacts/changelog-${VERSION}.md
          echo "" >> release_artifacts/changelog-${VERSION}.md

          # Append commit list between previous tag and current tag (or the commits on the tag if no previous tag)
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:'- %s' ${PREV_TAG}..${TAG} >> release_artifacts/changelog-${VERSION}.md
          else
            git log --pretty=format:'- %s' ${TAG} >> release_artifacts/changelog-${VERSION}.md
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.vars.outputs.VERSION }}
          path: release_artifacts/*

      - name: Create GitHub Release and attach artifacts
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

          tag: ${{ steps.vars.outputs.TAG }}
          name: Release ${{ steps.vars.outputs.TAG }}

          allowUpdates: true

          draft: false
          makeLatest: true

          # Path artifacts
          bodyFile: release_artifacts/changelog-${{ steps.vars.outputs.VERSION }}.md
          artifacts: "release_artifacts/*"

      - name: Clean up keystore
        if: always()
        run: |
          rm -f android/app/key.jks || true
          rm -f android/key.properties || true
